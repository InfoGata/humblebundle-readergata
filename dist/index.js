const r="https://www.humblebundle.com/api/v1/user/order?ajax=true",l=e=>{const t={Cookie:`_simpleauth_sess=${localStorage.getItem("simpleAuth")};`};return`https://cloudcors.audio-pwa.workers.dev?setRequestHeaders=${JSON.stringify(t)}&url=${e}`},d=async e=>{const o=["pdf","epub"],t=`https://www.humblebundle.com/api/v1/order/${e}?ajax=true`;return(await(await application.isLoggedIn()?await application.networkRequest(t):await fetch(l(t))).json()).subproducts.filter(i=>i.downloads.some(s=>s.platform==="ebook")).map(i=>({title:i.human_name,images:[{url:i.icon}],sources:i.downloads[0].download_struct.map(s=>({name:s.name,source:s.url.web,type:s.name.toLocaleLowerCase()==="pdf"?"application/pdf":"application/epub+zip"})).filter(s=>o.includes(s.name?.toLocaleLowerCase()||""))}))},m=async()=>{const e=await application.isLoggedIn()?await application.networkRequest(r):await fetch(l(r));if(e.status!==200)return[];const o=await e.json();let t=[];for(const n of o)t.push(d(n.gamekey));return(await Promise.all(t)).flat()},w=e=>{application.postUiMessage(e)},g=async()=>{const e=localStorage.getItem("simpleAuth")||"";w({type:"info",extensionedInstalled:await application.isNetworkRequestCorsDisabled(),simpleAuth:e})},c=async e=>({type:"publication",items:await m()});application.onUiMessage=async e=>{switch(e.type){case"check-login":g();break;case"save":e.simpleAuth&&(application.onGetFeed=c),localStorage.setItem("simpleAuth",e.simpleAuth),application.createNotification({message:"Save successful"});break}};const b=e=>new Promise((o,t)=>{const a=new FileReader;a.onload=n=>{o(n.target?.result)},a.onerror=n=>t(n),a.readAsBinaryString(e)});application.onGetPublication=async e=>{const t=await(await application.networkRequest(e.source)).blob();return{source:await b(t),sourceType:"binary"}};const p=e=>{localStorage.setItem("kb-color-mode",e)};application.onChangeTheme=async e=>{p(e)};const u=async()=>{const e=localStorage.getItem("simpleAuth"),o=await application.isLoggedIn();console.log("logged In:",o),(e||o)&&(application.onGetFeed=c);const t=await application.getTheme();p(t)};application.onPostLogin=u;u();
